<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Panel de Administración de Turnos</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
        }

        .semana-grid {
            display: flex;
            gap: 16px;
            margin-bottom: 30px;
        }

        .dia-card {
            flex: 1;
            background: #f9f9f9;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            position: relative;
            min-width: 120px;
            transition: box-shadow 0.2s;
        }

        .dia-card:hover,
        .dia-card.selected {
            box-shadow: 0 2px 8px #bbb;
            border: 2px solid #007bff;
        }

        .dia-card.hoy {
            border: 2px solid #28a745;
            box-shadow: 0 2px 12px #b2f2bb;
            background: #eaffea;
        }

        .dia-header {
            font-weight: bold;
            margin-bottom: 2px;
            font-size: 1.1em;
        }

        .dia-fecha {
            color: #888;
            font-size: 0.95em;
            margin-bottom: 8px;
        }

        .blocked {
            background: #eee !important;
            color: #888;
        }

        .btn {
            padding: 4px 10px;
            background: #d9534f;
            color: #fff;
            border: none;
            cursor: pointer;
            border-radius: 3px;
            margin-top: 6px;
        }

        .btn:hover {
            background: #c9302c;
        }

        .form-inline {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }

        .excel-table {
            border-collapse: collapse;
            margin-top: 12px;
            width: 100%;
            background: #f7f7f7;
        }

        .excel-table th,
        .excel-table td {
            border: 1px solid #ccc;
            padding: 6px 8px;
            text-align: center;
        }

        .excel-table th {
            background: #eaeaea;
        }

        .excel-table input {
            width: 90%;
            text-align: center;
        }

        .turnos-count {
            font-size: 0.98em;
            color: #555;
            margin-bottom: 2px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 10;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.25);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #fff;
            padding: 24px 18px;
            border-radius: 8px;
            min-width: 320px;
            max-width: 95vw;
        }

        .modal-header {
            font-weight: bold;
            margin-bottom: 12px;
        }

        .modal-close {
            float: right;
            cursor: pointer;
            color: #d9534f;
            font-size: 1.2em;
        }

        .rangos-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .rangos-row {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .tabla-turnos-fija {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            background: #fff;
            box-shadow: 0 -2px 12px #bbb;
            padding: 18px 40px 24px 40px;
            z-index: 20;
        }

        .tabla-turnos-fija h3 {
            margin-top: 0;
        }

        .hoy {
            background: #d1e7dd;
        }
    </style>
    <script>
        // Definir variables globales con datos de Flask/Jinja2
        let diasSemana = {{ dias_semana | tojson }};
        let diasBloqueados = {{ dias_bloqueados | tojson }};
        let diaSeleccionado = 0;
        let confirmCallback = null;
        function seleccionarDia(idx) {
            diaSeleccionado = idx;
            document.querySelectorAll('.dia-card').forEach((el, i) => {
                if (i === idx) el.classList.add('selected');
                else el.classList.remove('selected');
            });
            renderTablaTurnos();
        }
        function confirmarAccion(mensaje, accion) {
            document.getElementById('modal-confirm-msg').innerText = mensaje;
            document.getElementById('modal-confirm').style.display = 'flex';
            confirmCallback = accion;
        }
        function closeConfirmModal() {
            document.getElementById('modal-confirm').style.display = 'none';
            confirmCallback = null;
        }
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('modal-confirm-ok').onclick = function () {
                if (confirmCallback) confirmCallback();
                closeConfirmModal();
            };
        });
        function bloquearDesbloquearDia() {
            const dia = diasSemana[diaSeleccionado];
            confirmarAccion(
                dia.bloqueado ? '¿Seguro que deseas desbloquear este día?' : '¿Seguro que deseas bloquear este día? No se podrán tomar turnos.',
                function () {
                    const form = document.createElement('form');
                    form.method = 'post';
                    form.action = dia.bloqueado ? '/desbloquear_dia' : '/bloquear_dia';
                    form.style.display = 'none';
                    const inputFecha = document.createElement('input');
                    inputFecha.type = 'hidden';
                    inputFecha.name = 'fecha';
                    inputFecha.value = dia.fecha;
                    form.appendChild(inputFecha);
                    const inputSemana = document.createElement('input');
                    inputSemana.type = 'hidden';
                    inputSemana.name = 'semana';
                    inputSemana.value = '{{ semana_inicio_str }}';
                    form.appendChild(inputSemana);
                    document.body.appendChild(form);
                    form.submit();
                }
            );
        }
        function eliminarTurno(id) {
            confirmarAccion('¿Seguro que deseas eliminar este turno?', function () {
                const form = document.createElement('form');
                form.method = 'post';
                form.action = '/eliminar/' + id;
                form.style.display = 'none';
                document.body.appendChild(form);
                form.submit();
            });
        }
        function editarRangosDia() {
            const dia = diasSemana[diaSeleccionado];
            openModal(dia.nombre, dia.fecha, dia.horario.manana, dia.horario.tarde);
        }
        function renderTablaTurnos() {
            const dia = diasSemana[diaSeleccionado];
            // Marcar como vistos los turnos nuevos de este día
            let vistos = JSON.parse(localStorage.getItem('turnos_vistos') || '[]');
            let nuevosVistos = false;
            for (const t of dia.turnos) {
                if (t[5] && !vistos.includes(t[0])) {
                    vistos.push(t[0]);
                    nuevosVistos = true;
                }
            }
            if (nuevosVistos) localStorage.setItem('turnos_vistos', JSON.stringify(vistos));
            let html = `<h3>Turnos para ${dia.nombre} (${dia.fecha})</h3>`;
            html += `<button class='btn' style='margin-right:10px;' onclick='bloquearDesbloquearDia();return false;'>${dia.bloqueado ? 'Desbloquear día' : 'Bloquear día'}</button>`;
            html += `<button class='btn' onclick='editarRangosDia();return false;'>Editar rangos</button>`;
            html += `<table class='excel-table'><tr><th>Hora</th><th>Nombre</th><th>Profesional</th><th>Teléfono</th><th>Acción</th></tr>`;
            if (dia.turnos.length > 0) {
                for (const t of dia.turnos) {
                    const esNuevo = t[5] && !vistos.includes(t[0]);
                    const profesionalNombre = t[6] || 'N/A';
                    const profesionalColor = t[7] || '#666666';

                    // Estilo de fila con color del profesional como borde izquierdo
                    const rowStyle = esNuevo ? `background:#eaffea; border-left: 4px solid ${profesionalColor};` : `border-left: 4px solid ${profesionalColor};`;

                    html += `<tr style='${rowStyle}'>
                        <td><input type='text' value='${t[3]}' readonly></td>
                        <td><input type='text' value='${t[1]}' readonly>${esNuevo ? " <span style='color:#28a745;font-weight:bold;font-size:0.95em;' title='Turno reciente'>&#9733; Nuevo</span>" : ""}</td>
                        <td style='text-align: center;'>
                            <span style='background-color: ${profesionalColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold;'>
                                ${profesionalNombre}
                            </span>
                        </td>
                        <td><input type='text' value='${t[4]}' readonly></td>
                        <td><button class='btn' onclick='eliminarTurno(${t[0]});return false;'>✕</button></td>
                    </tr>`;
                }
            } else {
                html += `<tr><td colspan='5'>Sin turnos</td></tr>`;
            }
            html += `</table>`;
            document.getElementById('tabla-turnos-fija').innerHTML = html;
        }
        function toggleVista() {
            const semana = document.getElementById('contenedor-semana');
            const mes = document.getElementById('contenedor-mes');
            const btn = document.getElementById('toggle-vista');
            if (semana.style.display !== 'none') {
                semana.style.display = 'none';
                mes.style.display = 'block';
                btn.innerText = 'Ver semana';
                renderMesGrid();
            } else {
                semana.style.display = 'block';
                mes.style.display = 'none';
                btn.innerText = 'Ver mes completo';
            }
        }
        function renderMesGrid() {
            const hoy = new Date();
            const year = hoy.getFullYear();
            const month = hoy.getMonth();
            const primerDia = new Date(year, month, 1);
            const ultimoDia = new Date(year, month + 1, 0);
            const diasEnMes = ultimoDia.getDate();
            let html = '<table class="excel-table"><tr>';
            const nombresDias = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'];
            for (const nd of nombresDias) html += `<th>${nd}</th>`;
            html += '</tr><tr>';
            let diaSemana = (primerDia.getDay() + 6) % 7; // Lunes=0
            for (let i = 0; i < diaSemana; i++) html += '<td></td>';
            for (let d = 1; d <= diasEnMes; d++) {
                const fecha = new Date(year, month, d);
                const fechaStr = fecha.toISOString().slice(0, 10);
                const bloqueado = diasBloqueados.includes(fechaStr);
                html += `<td style='cursor:pointer;${bloqueado ? "background:#fbb; color:#a00;" : ""}' onclick='toggleBloqueoMes("${fechaStr}")'>${d}${bloqueado ? "<br><span style='font-size:0.8em;'>(bloqueado)</span>" : ""}</td>`;
                if ((diaSemana + d) % 7 === 0 && d !== diasEnMes) html += '</tr><tr>';
            }
            html += '</tr></table>';
            document.getElementById('mes-grid').innerHTML = html;
        }
        function toggleBloqueoMes(fecha) {
            const form = document.createElement('form');
            form.method = 'post';
            const bloqueado = diasBloqueados.includes(fecha);
            form.action = bloqueado ? '/desbloquear_dia' : '/bloquear_dia';
            form.style.display = 'none';
            const inputFecha = document.createElement('input');
            inputFecha.type = 'hidden';
            inputFecha.name = 'fecha';
            inputFecha.value = fecha;
            form.appendChild(inputFecha);
            const inputSemana = document.createElement('input');
            inputSemana.type = 'hidden';
            inputSemana.name = 'semana';
            inputSemana.value = '{{ semana_inicio_str }}';
            form.appendChild(inputSemana);
            document.body.appendChild(form);
            form.submit();
        }
        function openModal(nombre, fecha, manana, tarde) {
            document.getElementById('modal').style.display = 'flex';
            document.getElementById('modal-dia').innerText = nombre + ' (' + fecha + ')';
            document.getElementById('modal-dia-input').value = nombre;
            document.getElementById('modal-semana-input').value = '{{ semana_inicio_str }}';
            document.getElementById('manana_hora_inicio').value = manana.hora_inicio;
            document.getElementById('manana_hora_fin').value = manana.hora_fin;
            document.getElementById('manana_intervalo').value = manana.intervalo;
            document.getElementById('tarde_hora_inicio').value = tarde.hora_inicio;
            document.getElementById('tarde_hora_fin').value = tarde.hora_fin;
            document.getElementById('tarde_intervalo').value = tarde.intervalo;
        }
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }
        function getSemanaActual() {
            // Lee el valor del input oculto que siempre refleja la semana visible
            let semana = document.getElementById('semana-actual');
            if (semana) return semana.value;
            return '{{ semana_inicio_str }}';
        }
        setInterval(() => location.reload(), 30000); // Recarga la página cada 30 segundos
    </script>
</head>

<body>
    <input type="hidden" id="semana-actual" value="{{ semana_inicio_str }}">
    <h1>Panel de Administración de Turnos</h1>
    <div style="margin-bottom:18px;">
        <button class="btn" id="toggle-vista" onclick="toggleVista()">Ver mes completo</button>
    </div>
    <div id="contenedor-semana">
        <h3>Calendario semanal</h3>
        <div class="semana-grid">
            {% for dia in dias_semana %}
            <div class="dia-card {% if dia['bloqueado'] %}blocked{% endif %} {% if dia['es_hoy'] %}hoy{% endif %}"
                onclick="seleccionarDia({{ loop.index0 }})">
                <div class="dia-header" style="user-select:none;">{{ dia['nombre'] }}</div>
                <div class="dia-fecha">{{ dia['fecha'] }}</div>
                <div class="turnos-count">
                    {% if dia['bloqueado'] %}
                    Día bloqueado
                    {% else %}
                    {{ dia['turnos']|length }} turno{{ 's' if dia['turnos']|length != 1 else '' }}
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    <div id="contenedor-mes" style="display:none;">
        <h3>Calendario mensual</h3>
        <div id="mes-grid"></div>
    </div>
    <div class="tabla-turnos-fija" id="tabla-turnos-fija"></div>
    <div class="modal" id="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <div class="modal-header">Editar rangos de <span id="modal-dia"></span></div>
            <form class="rangos-form" method="post" action="/configurar_rangos">
                <input type="hidden" name="nombre_dia" id="modal-dia-input">
                <input type="hidden" name="semana" id="modal-semana-input">
                <div class="rangos-row"><b>Mañana:</b>
                    <label>Inicio <input type="number" name="manana_hora_inicio" id="manana_hora_inicio" min="0"
                            max="23"></label>
                    <label>Fin <input type="number" name="manana_hora_fin" id="manana_hora_fin" min="0"
                            max="23"></label>
                    <label>Intervalo <input type="number" name="manana_intervalo" id="manana_intervalo" min="5" max="60"
                            step="5"></label>
                </div>
                <div class="rangos-row"><b>Tarde:</b>
                    <label>Inicio <input type="number" name="tarde_hora_inicio" id="tarde_hora_inicio" min="0"
                            max="23"></label>
                    <label>Fin <input type="number" name="tarde_hora_fin" id="tarde_hora_fin" min="0" max="23"></label>
                    <label>Intervalo <input type="number" name="tarde_intervalo" id="tarde_intervalo" min="5" max="60"
                            step="5"></label>
                </div>
                <button class="btn" type="submit">Guardar rangos</button>
            </form>
        </div>
    </div>
    <div class="modal" id="modal-confirm">
        <div class="modal-content" style="max-width:340px;">
            <div class="modal-header" id="modal-confirm-msg"></div>
            <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:18px;">
                <button class="btn" style="background:#888;" onclick="closeConfirmModal()">Cancelar</button>
                <button class="btn" id="modal-confirm-ok">Confirmar</button>
            </div>
        </div>
    </div>
</body>

</html>